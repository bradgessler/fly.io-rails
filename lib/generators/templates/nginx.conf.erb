<% if @serverless -%>
passenger_ctl hook_detached_process /etc/nginx/hook_detached_process;
passenger_min_instances 0;
passenger_pool_idle_time 300;

<% end -%>
access_log /dev/stdout;
error_log /dev/stdout info;

server {
    listen 8080;
    server_name <%= @app %>.fly.dev;
    root /app/public;

    passenger_enabled on;
    passenger_ruby /usr/lib/fullstaq-ruby/versions/<%= @ruby_version %>-jemalloc/bin/ruby;

    passenger_env_var RAILS_SERVE_STATIC_FILES true;
    passenger_env_var RAILS_LOG_TO_STDOUT true;

<% if @cable -%>
location / {
  passenger_app_group_name <%= @app%>;
}

location /cable {
  passenger_app_group_name <%= @app%>-cable;
  passenger_force_max_concurrent_requests_per_process 0;
}

<% end -%>
    # Nginx has a default limit of 1 MB for request bodies, which also applies
    # to file uploads. The following line enables uploads of up to 50 MB:
    client_max_body_size 50M;
}
